<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dolphin</title>
    <style>

    </style>
</head>
<body>
<h1>Dolphin</h1>
<button id="add">add</button>
<div id="inputs">
</div>


<output id="out"></output>

<script type="module">

    import {defaultConsoleLogging} from "../../kolibri/logger/loggingSupport.js";
    import {LoggerFactory}                                                     from "../../kolibri/logger/loggerFactory.js";
    import {
        ACTION_KEY,
        KEY_PARAM, PAYLOAD_KEY, REMOVE_ACTION_NAME,
        TOPIC_REMOTE_OBSERVABLE,
        UPDATE_ACTION_NAME,
        UPDATE_ACTION_PARAM
    } from "./romConstants.js";
    import {client} from "../../kolibri/rest/restClient.js";
    import {OM}          from "../../tetris/observableMap/om.js";
    import {dom, select} from "../../kolibri/util/dom.js";
    import {LOG_DEBUG}                                                         from "../../kolibri/logger/logLevel.js";

    defaultConsoleLogging("ch.fhnw", LOG_DEBUG);

    const log = LoggerFactory("ch.fhnw.kolibri.remote.rom");

    const om = OM("index.html");

    const baseUrl = window.location.origin;
    const eventSource = new EventSource(baseUrl + '/' + TOPIC_REMOTE_OBSERVABLE);

    eventSource.addEventListener('message', event =>
        log.warn("unknown event type " + event)
    );
    eventSource.addEventListener('error', err =>
        log.error("SSE error " + err)
    );
    eventSource.addEventListener(TOPIC_REMOTE_OBSERVABLE, event => {
        const data    = JSON.parse(event.data);
        const action  = data[ACTION_KEY];
        const payload = data[PAYLOAD_KEY];
        switch (action) {
            case UPDATE_ACTION_NAME:
                om.setValue(payload.key, payload.value);
                break;
            case REMOVE_ACTION_NAME:
                om.removeKey(payload.key);
                break;
            default:
                log.error(`cannot process received data: ${event.data}`)
        }
    });

    om.onChange( ( key, value ) => { // also handles the keyAdded case implicitly
        const data = {
            [KEY_PARAM] :           key,
            [UPDATE_ACTION_PARAM] : value
        };
        log.debug(`sending update key ${key} value ${value}`);
        client(baseUrl + '/' + UPDATE_ACTION_NAME, "POST", data)
            .then(  _ => log.debug("done sending update"))
            .catch( e => log.error("error sending update data: "+ JSON.stringify(data) + " " + e));
    } );

    om.onKeyRemoved( ( key ) => {
        const data = {
            [KEY_PARAM] :           key
        };
        log.debug(`sending remove key ${key}`);
        client(baseUrl + '/' + REMOVE_ACTION_NAME, "DELETE", data)
            .then(  _ => log.debug("done sending remove"))
            .catch( e => log.error("error sending remove data: "+ JSON.stringify(data) + " " + e));
    } );

    let keyCount = 0; // how many keys we have seen
    om.onKeyAdded( key => {
        keyCount++;
        const [br, label, button] = dom(`<br><label>${key} <input></label><button>x</button>`);
        inputs.append(br, label, button);
        const [input] = select(label, "input");
        input.oninput = _ => om.setValue(key, input.value);
        om.onChange( ( changedKey, value ) => {
            if (key === changedKey) {
                input.value = value;
            }
        });
        om.onKeyRemoved( removedKey => {
            if (removedKey === key) {
                br.remove();
                label.remove();
                button.remove();
            }
        });
        button.onclick = _ => om.removeKey(key);
    });

    add.onclick = _ => om.setValue("key_"+keyCount, keyCount);






</script>


</body>
</html>
